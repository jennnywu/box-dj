/**************************************************************************************************/
/**
 * @file lcd.c
 * @author Ryan Jing (r5jing@uwaterloo.ca)
 * @brief
 *
 * @version 0.1
 * @date 2025-11-08
 *
 * @copyright Copyright (c) 2025
 *
 */
/**************************************************************************************************/

/*------------------------------------------------------------------------------------------------*/
/* HEADERS                                                                                        */
/*------------------------------------------------------------------------------------------------*/

#include <stdio.h>
#include "esp_err.h"
#include "esp_log.h"
#include "driver/gpio.h"
#include "lcd.h"


/*------------------------------------------------------------------------------------------------*/
/* MACROS                                                                                         */
/*------------------------------------------------------------------------------------------------*/


/*------------------------------------------------------------------------------------------------*/
/* GLOBAL VARIABLES                                                                               */
/*------------------------------------------------------------------------------------------------*/


static hd44780_t lcd = {
    .pins = {
        .rs = GPIO_NUM_18,
        .e  = GPIO_NUM_19,
        .d4 = GPIO_NUM_23,
        .d5 = GPIO_NUM_22,
        .d6 = GPIO_NUM_21,
        .d7 = GPIO_NUM_5,
        .bl = HD44780_NOT_USED  // Or assign a GPIO if you wired backlight
    },
    .font = HD44780_FONT_5X8,
    .lines = 2
};

/*------------------------------------------------------------------------------------------------*/
/* FUNCTION PROTOTYPES                                                                            */
/*------------------------------------------------------------------------------------------------*/



/*------------------------------------------------------------------------------------------------*/
/* FUNCTION DEFINITIONS                                                                           */
/*------------------------------------------------------------------------------------------------*/

esp_err_t lcd_init(void)
{
    esp_err_t ret = hd44780_init(&lcd);

    if (ret != ESP_OK) {
        ESP_LOGE("LCD", "Failed to initialize LCD: %s", esp_err_to_name(ret));
        return ret;
    }

    hd44780_clear(&lcd);
    hd44780_puts(&lcd, "LCD Ready");
    return ret;
}

esp_err_t lcd_show_now_playing(const char *song_name)
{
    esp_err_t ret;
    hd44780_clear(&lcd);
    hd44780_gotoxy(&lcd, 0, 0);
    hd44780_puts(&lcd, "Now Playing:");

    hd44780_gotoxy(&lcd, 0, 1);
    ret = hd44780_puts(&lcd, song_name);

    if (ret != ESP_OK) {
        ESP_LOGE("LCD", "Failed to display song name: %s", esp_err_to_name(ret));
    }

    return ret;
}